<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<script src="../node_modules/redux/dist/redux.js"></script>

<script>
  const initialState = {
    user: null,
    users: [],
    tournaments: [],
    tournamentFilter: 'all',
    songs: [],
    matchups: [],
    routeSubject: new Rx.Subject(),
    selectedMatchup: null,
    selectedBattle: null,
  }

  const addEntrant = (state, tournamentId, userId) => {
    const newState = Object.assign({}, state)
    newState.tournaments = state.tournaments.map((t) => {
      if (t._id === tournamentId) {
        const newT = Object.assign({}, t)
        newT.entrants = [...newT.entrants, userId]
        return newT
      }
      return t
    })
    return newState
  }

  const removeEntrant = (state, tournamentId, userId) => {
    const newState = Object.assign({}, state)
    newState.tournaments = state.tournaments.map((t) => {
      if (t._id === tournamentId) {
        const newT = Object.assign({}, t)
        newT.entrants = newT.entrants.filter((x) => x !== userId )
        return newT
      }
      return t
    })
    return newState
  }

  const reducer = (state, action) => {
    if (!state) return initialState

    switch (action.type) {
      case 'changeUser':
        const user = action.user
        return Object.assign({}, state, { user: user })
        break;
      case 'updateTournaments':
        const tournaments = action.tournaments
        return Object.assign({}, state, { tournaments: tournaments })
        break;
      case 'updateTournament':
        const tournament = action.tournament
        const updatedTournaments = state.tournaments.map((t) => {
          if (t._id === tournament._id) {
            return tournament
          }
          return t
        })
        return Object.assign({}, state, { tournaments: updatedTournaments })
        break;
      case 'updateMatchups':
        const matchups = action.matchups
        return Object.assign({}, state, { matchups: matchups })
        break;
      case 'updateMatchup':
        const matchup = action.matchup
        const updatedMatchups = state.matchups.map((m) => {
          if (m._id === matchup._id) {
            return matchup
          }
          return m
        })
        return Object.assign({}, state, { matchups: updatedMatchups })
        break;
      case 'updateSongs':
        const songs = action.songs
        return Object.assign({}, state, { songs: songs })
        break;
      case 'addEntrant':
        return addEntrant(state, action.tournamentId, action.userId)
        break
      case 'removeEntrant':
        return removeEntrant(state, action.tournamentId, action.userId)
        break
      case 'changeTournamentFilter':
        return Object.assign({}, state, { tournamentFilter: action.filter || 'all' })
        break
      case 'selectMatchupBattle':
        return Object.assign({}, state, {selectedBattle: action.battle, selectedMatchup: action.matchup})
        break
      default:
        throw Error('unknown action type')
    }
  }

  const Store = Redux.createStore(reducer, window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__())
  ReduxMixin = PolymerRedux(Store)

</script>