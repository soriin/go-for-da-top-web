<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../reduxMixin.html">
<link rel="import" href="../vendor/lodash.html">
<link rel="import" href="../mixins/formatterMixin.html">

<dom-module id="gfdt-matchup-list-item">
  <template>
    <style include="shared-styles">
      .winner {
        color: green
      }

      .loser {
        color: red
      }

      .draw {
        color: blue
      }
    </style>
    <div>
      <h2>[[formatDate(matchup.startDate)]] - [[formatDate(matchup.endDate)]]</h2>
    </div>
    <div style="display:flex">
      <div>
        <span class$="[[getPlayerStyle(battleOne.chooser)]]">[[battleOne.chooser.displayName]] ({{getPlayerScore(battleOne.chooser)}})</span>
        <div>
          [[getSongString(battleOne.song)]]
          <div hidden$="[[isMatchupVerified]]">
            <paper-button hidden$="[[!isSongSelected(battleOne)]]" on-tap="redirectToBattlePage" data-battle$="[[battleOne]]">Submit Score</paper-button>
            <paper-button hidden$="[[!canPickSong(battleOne)]]" on-tap="redirectToSongSelection(battleOne)">Pick Song</paper-button>
          </div>
          <paper-button hidden$="[[!isMatchupVerified]]" on-tap="redirectToBattlePage" data-battle$="[[battleOne]]">View Results</paper-button>
        </div>
      </div>
      <div style="padding: 0 20px 0 20px">
        <span>VS</span>
      </div>
      <div>
        <span class$="[[getPlayerStyle(battleTwo.chooser)]]">[[battleTwo.chooser.displayName]] ({{getPlayerScore(battleTwo.chooser)}})</span>
        <div>
          [[getSongString(battleTwo.song)]]
          <div hidden$="[[isMatchupVerified]]">
            <paper-button hidden$="[[!isSongSelected(battleTwo)]]" on-tap="redirectToBattlePage" data-battle$="[[battleTwo]]">Submit Score</paper-button>
            <paper-button hidden$="[[!canPickSong(battleTwo)]]" on-tap="redirectToSongSelection(battleTwo)">Pick Song</paper-button>
          </div>
          <paper-button hidden$="[[!isMatchupVerified]]" on-tap="redirectToBattlePage" data-battle$="[[battleTwo]]">View Results</paper-button>
        </div>
      </div>
    </div>
  </template>
  <script>
    class MatchupListItem extends FormatterMixin(ReduxMixin(Polymer.Element)) {
      isVerified() {
        return !!this.matchup.verification
      }

      isSongSelected(battle) {
        return !!battle.song
      }

      canPickSong(battle) {
        if (battle.song) return false
        if (battle.chooser._id === Store.getState().user._id) {
          return true
        }
        return false
      }

      getSongString(song) {
        if (song) {
          return `${song.title} by ${song.artist}`
        }
        return 'Song Not Chosen, Yet'
      }

      getPlayerScore(player) {
        if (!this.isVerified()) return '??'
        return this.matchup.players.filter(p => p.user._id === player._id)[0].score
      }

      getPlayerStyle(player) {
        if (!this.isVerified()) return

        const thisGuysScore = this.matchup.players.filter(p => p.user._id === player._id)[0].score
        const otherGuysScore = this.matchup.players.filter(p => p.user._id !== player._id)[0].score

        if (thisGuysScore === otherGuysScore) return 'draw'
        if (thisGuysScore > otherGuysScore) return 'winner'
        return 'loser'
      }

      getBattle(matchup, index) {
        return matchup.battles[index]
      }

      redirectToBattlePage(ev) {
        const {battle} = ev.target.dataset
        this.dispatch('selectBattle', this.matchup, JSON.parse(battle))
        Store.getState().routeSubject.next('matchups')
      }

      static get is() { return 'gfdt-matchup-list-item'; }
      static get actions() {
        return {
          selectBattle(matchup, battle) {
            return {
              matchup,
              battle,
              type: 'selectMatchupBattle'
            }
          },
        }
      }
      static get properties() {
        return {
          matchup: {
            type: Object
          },
          isMatchupVerified: {
            type: Boolean,
            computed: 'isVerified(matchup.verification)'
          },
          battleOne: {
            type: Object,
            computed: 'getBattle(matchup, 0)'
          },
          battleTwo: {
            type: Object,
            computed: 'getBattle(matchup, 1)'
          }
        }
      }

      static get observers() {
        return [
        ]
      }
    }
    window.customElements.define(MatchupListItem.is, MatchupListItem)
  </script>
</dom-module>