<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-number-input/paper-number-input.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker-light.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../reduxMixin.html">
<link rel="import" href="../services/tournamentService.html">
<link rel="import" href="../vendor/moment.html">

<dom-module id="gfdt-tournament-form">
  <template>
    <style include="shared-styles">

    </style>
    <iron-form id="tournamentForm" allowRedirect="false">
      <form>
        <iron-input bind-value={{currentTournament.title}}>
          <paper-input label="Title" name="title"></paper-input>
        </iron-input>
        <vaadin-date-picker-light custom-date-valid-filter="[[customDateValidFilter]]">
          <iron-input bind-value={{currentTournament.startDate}}>
            <input placeholder="Start Date" size="10" name="startDate">
          </iron-input>
        </vaadin-date-picker-light>
        <iron-input bind-value={{currentTournament.weeks}}>
          <paper-number-input label="Weeks" name="weeks" min="1"></paper-number-input>
        </iron-input>
        <div hidden$="[[!endDate]]">
          <span>End Date: [[endDate]]</span>
        </div>
        <paper-button on-tap="formSubmit" class="" raised>Create</paper-button>
      </form>
    </iron-form>
  </template>

  <script>
    class TournamentForm extends ReduxMixin(Polymer.Element) {
      constructor() {
        super()
        this.tournamentSvc = new TournamentService()
      }

      toastMe(message) {
        document.dispatchEvent(new CustomEvent('paper-snackbar-notify', {
          bubbles: true,
          composed: true,
          detail: {
            message: message
          }
        }));
      }

      async formSubmit() {
        try {
          const form = this.$.tournamentForm;
          const formValues = form.serializeForm()
          const payloadData = {
            title: formValues.title,
            startDate: formValues.startDate,
            endDate: formValues.endDate,
          }
          const response = await this.tournamentSvc.create(payloadData)
          if (response.ok) {
            this.toastMe('Tournament successfully created')
          } else {
            this.toastMe('Tournament creation failed')
          }
        } catch (e) {
          console.error(e)
          this.toastMe('Tournament creation failed horribly')
        }
      }

      getEndDate(startDate, weeks) {
        console.log(startDate, weeks)
        const date = moment(startDate)
        if (!date.isValid()) { return }
        this.endDate = date.add(weeks, 'weeks').format('L')
      }

      dataChanged(changeRecord) {
        console.log(changeRecord)
      }

      get customDateValidFilter() {
        return {
          filter(date) {
            const momentDate = moment(date)
            if (!momentDate.isValid()) { return false }

            if (momentDate.day() === 1) { return true }

            return false
          }
        }
      }

      static get is() { return 'gfdt-tournament-form'; }
      static get actions() {
        return {
          updateTournament(tournament) {

          }
        }
      }
      static get properties() {
        return {
          currentTournament: {
            type: Object,
            value: {
              startDate: null,
              title: null,
              weeks: 1
            },
            endDate: String
          }
        }
      }

      static get observers() {
        return [
          'getEndDate(currentTournament.startDate, currentTournament.weeks)'
        ]
      }
    }

    window.customElements.define(TournamentForm.is, TournamentForm);
  </script>
</dom-module>