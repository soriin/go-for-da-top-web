<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../reduxMixin.html">
<link rel="import" href="../services/tournamentService.html">
<link rel="import" href="../vendor/lodash.html">
<link rel="import" href="../vendor/moment.html">
<link rel="import" href="../mixins/formatterMixin.html">
<link rel="import" href="../helpers/permissionHelper.html">

<dom-module id="gfdt-tournaments">
  <template>
    <style include="shared-styles">

    </style>
    <div class="tournaments-container">
      <div>
          Tournaments!
          <div hidden$="[[!isAdmin()]]">
              <paper-button on-tap="redirectToCreate">Create</paper-button>
          </div>
      </div>
      <div>
        <paper-button on-tap="setFilter" data-filter="mine">Only Mine</paper-button>
        <paper-button on-tap="setFilter" data-filter="all">All</paper-button>
      </div>

      <template is="dom-repeat" items="[[tournamentsToDisplay]]" as="tournament">
        <h1>[[tournament.title]]</h1>
        <span>[[formatDate(tournament.startDate)]] - [[formatDate(tournament.endDate)]]</span>
        <div hidden$="[[!tournament.isActive]]">
          <span>IN PROGRESS</span>
        </div>
        <div hidden$="[[!canJoin(tournament, user._id)]]">
          <paper-button on-tap="join" data-tournament-id$="[[tournament._id]]" raised>Join</paper-button>
        </div>
        <div hidden$="[[!canLeave(tournament, user._id)]]">
          <paper-button on-tap="leave" data-tournament-id$="[[tournament._id]]" raised>Leave</paper-button>
        </div>
        <div hidden$="[[!canActivate(tournament, user._id)]]">
          <paper-button on-tap="activate" data-tournament-id$="[[tournament._id]]" raised>Start!</paper-button>
        </div>
      </template>
    </div>
  </template>

  <script>
    class Tournaments extends FormatterMixin(ReduxMixin(Polymer.Element)) {
      constructor() {
        super()
        this.tournamentSvc = new TournamentService()
        this.permissionHelper = new PermissionHelper()
        this.refreshTournaments()
      }

      canJoin(tournament, userId) {
        return !tournament.entrants.includes(userId) && !tournament.isActive
      }

      canLeave(tournament, userId) {
        return tournament.entrants.includes(userId) && !tournament.isActive
      }

      canActivate(tournament, userId) {
        return tournament.organizers.includes(userId) && !tournament.isActive
      }

      redirectToCreate() {
        Store.getState().routeSubject.next('create-tournament')
      }

      isAdmin() {
        return this.permissionHelper.isAdmin()
      }

      async refreshTournaments() {
        try {
          const response = await this.tournamentSvc.getAll()
          if (response.ok) {
            const data = await response.json()
            this.dispatch('updateTournaments', data)
            this.tournamentsToDisplay = data
          }
        } catch (e) {
          console.error('error updating tournaments', e)
        }
      }

      setFilter(ev) {
        this.dispatch('changeTournamentFilter', ev.target.dataset.filter)
      }

      tournamentListChanged() {
        switch (this.tournamentFilter) {
          case 'mine':
            return this.tournaments.filter((t) => t.entrants.includes(this.user._id))
          case 'all':
          default:
            return this.tournaments
        }
      }

      async join(ev) {
        try {
          const tournamentId = ev.target.dataset.tournamentId
          const response = await this.tournamentSvc.join(tournamentId)
          if (response.ok) {
            const data = await response.json()
            this.dispatch('addEntrant', data.tournamentId, data.userId)
          }
        } catch (e) {
          console.error('error joining tournaments', e)
        }
      }

      async activate(ev) {
        try {
          const tournamentId = ev.target.dataset.tournamentId
          const response = await this.tournamentSvc.activate(tournamentId)
          if (response.ok) {
            const data = await response.json()
            this.dispatch('updateTournament', data)
          }
        } catch (e) {
          console.error('error activating tournaments', e)
        }
      }

      async leave(ev) {
        try {
          const tournamentId = ev.target.dataset.tournamentId
          const response = await this.tournamentSvc.leave(tournamentId)
          if (response.ok) {
            const data = await response.json()
            this.dispatch('removeEntrant', data.tournamentId, data.userId)
          }
        } catch (e) {
          console.error('error leaving tournaments', e)
        }
      }

      static get is() { return 'gfdt-tournaments'; }

      static get actions() {
        return {
          updateTournaments(tournaments) {
            return {
              tournaments,
              type: 'updateTournaments'
            }
          },
          updateTournament(tournament) {
            return {
              tournament,
              type: 'updateTournament'
            }
          },
          addEntrant(tournamentId, userId) {
            return {
              tournamentId,
              userId,
              type: 'addEntrant'
            }
          },
          removeEntrant(tournamentId, userId) {
            return {
              tournamentId,
              userId,
              type: 'removeEntrant'
            }
          },
          changeTournamentFilter(filter) {
            return {
              filter,
              type: 'changeTournamentFilter'
            }
          }
        }
      }

      static get properties() {
        return {
          tournaments: {
            type: Array,
            statePath: 'tournaments'
          },
          tournamentsToDisplay: {
            type: Array,
            computed: 'tournamentListChanged(tournaments.*, tournamentFilter)'
          },
          user: {
            type: Object,
            statePath: 'user'
          },
          tournamentFilter: {
            type: String,
            statePath: 'tournamentFilter'
          }
        }
      }
    }
    window.customElements.define(Tournaments.is, Tournaments);
  </script>
</dom-module>